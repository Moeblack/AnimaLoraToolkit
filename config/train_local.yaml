# Anima LoRA Trainer 本地配置
# 使用方法: python anima_train.py --config ./config/train_local.yaml
# 特点: 所有模型路径指向本地，无需联网

# ============================================================================
# 模型路径（本地硬链接/文件）
# ============================================================================
transformer_path: "models/transformers/anima-preview.safetensors"
vae_path: "models/vae/qwen_image_vae.safetensors"
text_encoder_path: "models/text_encoders"
t5_tokenizer_path: "models/t5_tokenizer"  # 本地 T5 tokenizer，避免联网

# ============================================================================
# 数据集（训练前请修改为实际数据集路径）
# ============================================================================
data_dir: "./dataset"
resolution: 1024
repeats: 1
shuffle_caption: true      # 分类打乱（JSON: appearance/tags/environment 内部打乱）
keep_tokens: 6             # 保留前 N 个 tokens 不打乱（仅对 TXT 模式生效）
flip_augment: true         # 随机水平翻转
tag_dropout: 0.0           # Tag dropout 概率 (0-1)
prefer_json: true          # 优先使用 JSON 文件（支持分类 shuffle）
cache_latents: true        # 缓存 VAE latent 到 npz 文件，加速训练

# ============================================================================
# LoRA 配置
# ============================================================================
lora_type: "lokr"         # lora 或 lokr
lora_rank: 32
lora_alpha: 32.0
lokr_factor: 8

# ============================================================================
# 训练参数
# ============================================================================
epochs: 15
max_steps: 0              # 0=无限制
batch_size: 1
grad_accum: 4
learning_rate: 1.0e-4
mixed_precision: "bf16"
grad_checkpoint: true
xformers: true            # 启用 xformers memory efficient attention
num_workers: 0

# ============================================================================
# 输出与保存
# ============================================================================
output_dir: "./output"
output_name: "anima_lora"
save_every: 5             # 每 5 个 epoch 保存
seed: 42

# ============================================================================
# 采样
# ============================================================================
sample_every: 5           # 每 5 个 epoch 采样
sample_prompt: "masterpiece, best quality, newest, safe, 1girl"

# ============================================================================
# 进度显示
# ============================================================================
loss_curve_steps: 100
no_progress: false
