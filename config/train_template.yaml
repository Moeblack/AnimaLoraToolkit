# ============================================================================
# AnimaLoraToolkit 配置模板
# 使用方法: python anima_train.py --config ./config/train_template.yaml
# 
# 其他配置:
#   - train_local.yaml     本地离线训练模板
# ============================================================================

# ============================================================================
# 模型路径
# ============================================================================
transformer_path: "models/transformers/anima-preview.safetensors"
vae_path: "models/vae/qwen_image_vae.safetensors"
text_encoder_path: "models/text_encoders"
t5_tokenizer_path: "models/t5_tokenizer"  # 内置 tokenizer，无需联网

# ============================================================================
# 数据集
# ============================================================================
data_dir: "./dataset"                # 数据集目录
resolution: 1024                     # 训练分辨率
repeats: 1                           # 数据重复次数（小数据集增加）

# Caption 处理
shuffle_caption: true                # 启用标签打乱
                                     #   - JSON 模式: 分类 shuffle（appearance/tags/environment 各自内部打乱）
                                     #   - TXT 模式: 全部标签打乱（配合 keep_tokens 使用）
keep_tokens: 0                       # 保护前 N 个标签不打乱（仅 TXT 模式生效，JSON 模式固定字段自动在前）
flip_augment: true                   # 水平翻转增强
tag_dropout: 0.0                     # 标签随机丢弃概率 (0-1)，增加泛化能力
prefer_json: true                    # 优先使用 JSON 标签文件（推荐，支持分类 shuffle）
cache_latents: true                  # 缓存 VAE latent（加速训练）

# ============================================================================
# LoRA / LoKr 配置
# ============================================================================
lora_type: "lokr"                    # "lora" 或 "lokr"
lora_rank: 32                        # LoRA rank (8/16/32/64)
lora_alpha: 32.0                     # 通常与 rank 相同
lokr_factor: 8                       # LoKr 专用参数

# ============================================================================
# 训练参数
# ============================================================================
epochs: 10                           # 训练轮数
max_steps: 0                         # 最大步数 (0=不限制)
batch_size: 1                        # 批次大小
grad_accum: 4                        # 梯度累积步数（有效 batch = batch_size × grad_accum）
learning_rate: 1.0e-4                # 学习率
mixed_precision: "bf16"              # 混合精度 ("bf16", "fp16", "no")
grad_checkpoint: true                # 梯度检查点（省显存）
xformers: false                      # xformers attention（5090 用 false）
num_workers: 0                       # 数据加载线程（Windows 必须为 0）

# ============================================================================
# 输出与保存
# ============================================================================
output_dir: "./output"               # 输出目录
output_name: "anima_lora"            # 输出文件名
save_every: 0                        # 每 N 个 epoch 保存 LoRA (0=禁用)
save_every_steps: 500                # 每 N step 保存 LoRA (推荐)
save_state_every: 1000               # 每 N step 保存完整训练状态（可断点续训）
seed: 42                             # 随机种子

# ============================================================================
# 继续训练（可选）
# ============================================================================
# resume_lora: ""                    # 从已有 LoRA 继续训练（仅加载权重）
# resume_state: ""                   # 从训练状态恢复（完整断点续训）

# ============================================================================
# 采样配置
# ============================================================================
sample_every: 5                      # 每 N 个 epoch 采样 (0=禁用)
sample_steps: 0                      # 每 N step 采样 (0=禁用)
sample_infer_steps: 25               # 推理步数
sample_cfg_scale: 4.0                # CFG Scale
sample_sampler_name: "er_sde"        # 采样器
sample_scheduler: "simple"           # 调度器
sample_width: 0                      # 采样宽度 (0=跟随 resolution)
sample_height: 0                     # 采样高度 (0=跟随 resolution)
sample_seed: 0                       # 采样种子 (0=随机)
sample_negative_prompt: ""           # 负面提示词

# 单提示词模式
sample_prompt: "newest, safe, 1girl, masterpiece, best quality"

# 多提示词轮换模式（优先于 sample_prompt）
# sample_prompts:
#   - "newest, safe, 1girl, character a, series, @artist, ..."
#   - "newest, safe, 1boy, character b, series, @artist, ..."

# ============================================================================
# 进度显示与监控
# ============================================================================
loss_curve_steps: 100                # 终端显示最近 N 步的 loss 曲线
no_progress: false                   # 禁用进度条
log_every: 10                        # 日志输出间隔（步）

# Web 监控面板（默认 http://127.0.0.1:8765）
# no_monitor: false                  # 禁用 Web 监控面板
# monitor_host: "127.0.0.1"          # 监控绑定地址（局域网用 0.0.0.0）
# monitor_port: 8765                 # 监控端口
# no_browser: false                  # 不自动打开浏览器
